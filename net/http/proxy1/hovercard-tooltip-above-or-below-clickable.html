<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<script type="text/javascript" src="jquery-min-2.1.1.js"></script>
<style type="text/css">
.popup_div {
    position:absolute;
    left:100px;
    top:100px;
    border:1px solid red;
    background-color:blue;
    width:150px;
    height:150px;
    background:url("arrow-desc.png") no-repeat scroll center 0 transparent;
    text-align:left;
}    
</style>
<body>

<div class="popup_div" style="display:none">popup</div>

<span style="display:inline-block;margin-left:10px">
    <a href="#" class="hover">hover<br>left</a>
</span>


<div style="position:relative;right:10px;float:right;">
    <br>
    <br>
    <br>
    <br>
    <a href="#" class="hover">right</a>
</div>
<br>

<span style="display:inline-block;height:300px;width:200px;background-color:#aaa;"> </span>

<p>Lorem ipsum <a id='xx' href="#" class="hover">hover2</a> bono.</p>

<script type="text/javascript">
$(function () {

    var obj = $('#xx');
    var wh = $( window ).height();      // Returns height of browser viewport
    var dh = $( document ).height();    // Returns height of HTML document
    var scrollVert = $('body').scrollTop();
    var os1 = obj.offset();
    var os2 = obj[0].getBoundingClientRect();
    console.log("height window - doc:",wh,dh," sctp:", scrollVert , " offs1",os1.top, " offs2", os2.top);
    console.log("offs1-l", os1.left, " offs2-l",  os2.left);


    $('.hover').hover(function () {
        var popup_div = $('.popup_div');
        var obj = $(this);
        var offset = obj.offset();
        var new_left = offset.left;
        new_left = new_left - (popup_div.width() / 2);
        new_left = new_left + (obj.width() / 2);
        if (new_left < 10){
            new_left = 10;
        }
        if (new_left + $('.popup_div').width() > $(window).width() - 10){
            new_left = $(window).width() - $('.popup_div').width() - 10;
        }
        var new_top = offset.top + obj.height() + 5;


        var offrel = obj[0].getBoundingClientRect()
        if (offrel.top > $(window).height() / 2) {
            console.log("ort>wh", offrel.top, $(window).height() / 2)
            popup_div.css({
                left: new_left + 'px',
                top: offset.top - popup_div.height() - 5 + 'px',
                'background-position': 'center 0',
                transform: 'scaleY(-1)',
            });
        } else {
            popup_div.css({
                left: new_left + 'px',
                top: new_top   + 'px',
                'background-position': 'center 0',
                transform: 'scaleY(1)',
            });
        }


        // popup_div.show();
        popup_div.stop(true, true).delay(200).fadeIn(500);

    }, function () {
        //hovered away so hide popup
        // $('.popup_div').hide();
        $('.popup_div').stop(true, true).fadeOut(300, function () {
            console.log("fadeout-callback");
        });

    });
});    
</script>
</body>
</html>